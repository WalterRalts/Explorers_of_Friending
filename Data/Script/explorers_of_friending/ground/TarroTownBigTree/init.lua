--[[
    init.lua
    Created: 09/18/2024 13:37:43
    Description: Autogenerated script file for the map TarroTownBigTree.
]]--
-- Commonly included lua functions and data
require 'explorers_of_friending.common'

-- Package name
local TarroTownBigTree = {}

-------------------------------
-- Map Callbacks
-------------------------------
---TarroTownBigTree.Init(map)
--Engine callback function
function TarroTownBigTree.Init(map)
  if GAME:GetPlayerPartyCount() == 2 then
    local mon_id1 = RogueEssence.Dungeon.MonsterID("sentret", 0, "normal", Gender.Female)

    local p1 = _DATA.Save.ActiveTeam:CreatePlayer(_DATA.Save.Rand, mon_id1, 6, "", 0)
    p1.IsFounder = true
    p1.IsPartner = true
    p1.Nickname = "Senna"

    _DATA.Save.ActiveTeam.Players:Add(p1)
    --
    local mon_id2 = RogueEssence.Dungeon.MonsterID("poochyena", 0, "normal", Gender.Male)

    local p2 = _DATA.Save.ActiveTeam:CreatePlayer(_DATA.Save.Rand, mon_id2, 11, "", 0)
    p2.IsFounder = true
    p2.IsPartner = true
    p2.Nickname = "Puchi"

    _DATA.Save.ActiveTeam.Players:Add(p2)
    --
    local mon_id3 = RogueEssence.Dungeon.MonsterID("zigzagoon", 0, "normal", Gender.Male)

    local p3 = _DATA.Save.ActiveTeam:CreatePlayer(_DATA.Save.Rand, mon_id3, 8, "", 0)
    p3.IsFounder = true
    p3.IsPartner = true
    p3.Nickname = "Ziggy"

    
    _DATA.Save.ActiveTeam.Players:Add(p3)
  end
  
 if SV.tarro_town.PieChapter == 7 then
  _DATA.Save.ActiveTeam.Players[2]:RefreshTraits()
  _DATA.Save.ActiveTeam.Players[3]:RefreshTraits()
  _DATA.Save.ActiveTeam.Players[4]:RefreshTraits()
  local talk_npc = RogueEssence.Dungeon.BattleScriptEvent("SennaInteract")
        _DATA.Save.ActiveTeam.Players[2].ActionEvents:Add(talk_npc)
        talk_npc = RogueEssence.Dungeon.BattleScriptEvent("PuchiInteract")
        _DATA.Save.ActiveTeam.Players[3].ActionEvents:Add(talk_npc)
        talk_npc = RogueEssence.Dungeon.BattleScriptEvent("ZiggyInteract")
        _DATA.Save.ActiveTeam.Players[4].ActionEvents:Add(talk_npc)
  MapStrings = STRINGS.MapStrings
  COMMON.RespawnAllies()
  TarroTownBigTree.TarroThingCut()
  local partner = CH('Teammate1')
  AI:SetCharacterAI(partner, "origin.ai.ground_partner", CH('PLAYER'), partner.Position)
  partner.CollisionDisabled = true

  local partner2 = CH('Teammate2')
  AI:SetCharacterAI(partner2, "origin.ai.ground_partner", CH('Teammate1'), partner2.Position)
  partner2.CollisionDisabled = true

  local partner3 = CH('Teammate3')
  AI:SetCharacterAI(partner3, "origin.ai.ground_partner", CH('Teammate2'), partner3.Position)
  partner3.CollisionDisabled = true

  local partner4 = CH('Teammate4')
  AI:SetCharacterAI(partner4, "origin.ai.ground_partner", CH('Teammate3'), partner4.Position)
  partner4.CollisionDisabled = true
  puchi_tired = true
 else
  MapStrings = STRINGS.MapStrings
  COMMON.RespawnAllies()
  local partner = CH('Teammate1')
  AI:SetCharacterAI(partner, "origin.ai.ground_partner", CH('PLAYER'), partner.Position)
  partner.CollisionDisabled = true

  local partner2 = CH('Teammate2')
  AI:SetCharacterAI(partner2, "origin.ai.ground_partner", CH('Teammate1'), partner2.Position)
  partner2.CollisionDisabled = true

  local partner3 = CH('Teammate3')
  AI:SetCharacterAI(partner3, "origin.ai.ground_partner", CH('Teammate2'), partner3.Position)
  partner3.CollisionDisabled = true

  local partner4 = CH('Teammate4')
  AI:SetCharacterAI(partner4, "origin.ai.ground_partner", CH('Teammate3'), partner4.Position)
  partner4.CollisionDisabled = true
  puchi_tired = true
 end
 if SV.tarro_town.PieChapter == 7 then
  GROUND:Hide("Thing")
 end
end

function TarroTownBigTree.TarroThingCut(map)
  local ama = CH("Thing")
  GAME:CutsceneMode(true)
  GAME:MoveCamera(464, 302, 7, false)
  
  local coro1 = TASK:BranchCoroutine(function() 
    GROUND:MoveToPosition(ama, 533, 254, false, 2)
    end)	
  local coro2 = TASK:BranchCoroutine(function() 
    GAME:FadeIn(40)
    end)
  
  TASK:JoinCoroutines({coro1, coro2})

  GROUND:CharAnimateTurn(ama, Direction.DownRight, 5, false)
  GAME:WaitFrames(20)
  GROUND:CharAnimateTurn(ama, Direction.UpLeft, 5, false)
  GAME:WaitFrames(25)
  GROUND:CharAnimateTurn(ama, Direction.DownLeft, 5, false)
  GAME:WaitFrames(34)
  GROUND:MoveToPosition(ama, 540, 232, false, 2)
  GROUND:Hide("Thing")
  local maru = CH("PLAYER")
  local azura = CH('Teammate1')
  local ziggy = CH("Teammate4")
  local senna = CH('Teammate2')
  local puchi = CH("Teammate3")
  
  GROUND:MoveInDirection(player, Direction.Down, 24, false, 2)
  
  local coro3 = TASK:BranchCoroutine(function()
    GAME:MoveCamera(0, 0, 180, true)
    UI:SetSpeaker(maru)
    UI:SetSpeakerEmotion("Stunned")
    UI:WaitShowDialogue("What was that thing?!")
    end)	
  local coro4 = TASK:BranchCoroutine(function() 
    GROUND:MoveToPosition(maru, 341, 376, false, 6)
    end)
  local coro5 = TASK:BranchCoroutine(function() 
    GROUND:MoveToPosition(azura, 359, 398, false, 2)
    end)	
  local coro6 = TASK:BranchCoroutine(function() 
    GROUND:MoveToPosition(ziggy, 314, 368, false, 3)
    end)
  local coro7 = TASK:BranchCoroutine(function() 
    GROUND:MoveToPosition(senna, 302, 398, false, 8)
  end)
  local coro8 = TASK:BranchCoroutine(function() 
    GROUND:MoveToPosition(puchi, 306, 342, false, 7)
  end)
  TASK:JoinCoroutines({coro3, coro4, coro5, coro6, coro7, coro8})
  
  
  UI:SetSpeaker(puchi)
  UI:SetSpeakerEmotion("Surprised")
  UI:WaitShowDialogue("It's going into the tree,[pause=33] we gotta stop it!")

  COMMON.FaceEachother("Puchi", "Senna")
  UI:SetSpeaker(senna)
  UI:SetSpeakerEmotion("Surprised")
  UI:WaitShowDialogue("H-[pause=10]huh...?![pause=25] We have to-[pause=30].[emote=Pain]..[pause=35]![br] Let's have the grown-ups deal with it.")

  COMMON.FaceEachother("Ziggy", "Senna")
  UI:SetSpeaker(ziggy)
  UI:SetSpeakerEmotion("Determined")
  UI:WaitShowTimedDialogue("They aren't here, Senna,[pause=35] come on! We might lose the tree!", 50)
  UI:WaitShowDialogue("No way![pause=15] We have to hurry up now now now!")

  UI:SetSpeaker(senna)
  UI:SetSpeakerEmotion("Sad")
  UI:WaitShowDialogue("B-but...[pause=40] but[emote=Teary-Eyed][pause=25] but...")

  UI:SetSpeaker(azura)
  UI:SetSpeakerEmotion("Sad")
  UI:WaitShowDialogue("Senna...")

  local function angyzig()
    COMMON.CharAngry("Ziggy")
  end

  UI:SetSpeaker(ziggy)
  UI:SetSpeakerEmotion("Determined")
  UI:WaitShowDialogue("Senna! You have us with you! T[emote=Angry][script=0]he epic Friend Circle will not be stopped!", {angyzig})
  UI:WaitShowDialogue("You can't keep being scared of battling! Just do it, it's not that bad!")

  UI:SetSpeaker(senna)
  UI:SetSpeakerEmotion("Teary-Eyed")
  UI:WaitShowDialogue("...")

  UI:SetSpeaker(ziggy)
  UI:SetSpeakerEmotion("Determined")
  UI:WaitShowDialogue("Give us a strong face, Senna!")

  UI:SetSpeaker(senna)
  UI:SetSpeakerEmotion("Sad")
  UI:WaitShowTimedDialogue("...", 65)
  UI:SetSpeakerEmotion("Worried")
  UI:WaitShowTimedDialogue("...", 64)
  UI:SetSpeakerEmotion("Determined")
  UI:WaitShowDialogue("...")

  UI:SetSpeaker(ziggy)
  UI:SetSpeakerEmotion("Happy")
  UI:WaitShowDialogue("There ya go!")

  UI:SetSpeaker(puchi)
  UI:SetSpeakerEmotion("Determined")
  UI:WaitShowDialogue("Alright then, let's go.")

  UI:SetSpeaker(puchi)
  UI:SetSpeakerEmotion("Pain")
  UI:WaitShowDialogue("(...why am I still so tired...?)")
  GAME:CutsceneMode(false)
end
---TarroTownBigTree.Enter(map)
--Engine callback function
function TarroTownBigTree.Enter(map)

  GAME:FadeIn(20)

end

---TarroTownBigTree.Exit(map)
--Engine callback function
function TarroTownBigTree.Exit(map)


end

---TarroTownBigTree.Update(map)
--Engine callback function
function TarroTownBigTree.Update(map)


end

---TarroTownBigTree.GameSave(map)
--Engine callback function
function TarroTownBigTree.GameSave(map)


end

---TarroTownBigTree.GameLoad(map)
--Engine callback function
function TarroTownBigTree.GameLoad(map)

  GAME:FadeIn(20)

end

-------------------------------
-- Entities Callbacks
-------------------------------
function TarroTownBigTree.TreeHallow_Entrance_Touch(obj, activator)
  COMMON.UnlockWithFanfare("tarro_tree_hollows", false)
  local dungeon_entrances = {"tarro_tree_hollows"}
  local ground_entrances = {}
  COMMON.ShowDestinationMenu(dungeon_entrances, ground_entrances)
end

function TarroTownBigTree.InfoSign_Action(obj, activator)
  local maru = CH("PLAYER")
  local azura = CH('Teammate1')
  local ziggy = CH("Teammate4")
  local senna = CH('Teammate2')
  local puchi = CH("Teammate3")

  UI:ResetSpeaker()
  UI:WaitShowDialogue("Today's news!:")
  UI:WaitShowDialogue("[speed=0.2]... ... ...")

  UI:SetSpeaker(senna)
  UI:SetSpeakerEmotion("Normal")
  UI:WaitShowDialogue("Weird, the sign is usually updated.")

  UI:SetSpeaker(ziggy)
  UI:SetSpeakerEmotion("Determined")
  UI:WaitShowDialogue("That thing probably has something to do with this!")

  UI:SetSpeaker(azura)
  UI:SetSpeakerEmotion("Determined")
  UI:WaitShowDialogue("Let's get after it!")
end

function TarroTownBigTree.Tree_2ndFloorEntrance_Touch(obj, activator)
  
end

function TarroTownBigTree.PurpKek_Counter_Action(obj, activator)
  UI:SetSpeaker(senna)
  UI:SetSpeakerEmotion("Normal")
  UI:WaitShowDialogue("Here is where the other Kecleon brother would set up shop.")

  UI:SetSpeaker(ziggy)
  UI:SetSpeakerEmotion("Worried")
  UI:WaitShowDialogue("Where did he go?")

  UI:SetSpeaker(puchi)
  UI:SetSpeakerEmotion("Worried")
  UI:WaitShowDialogue("Outside, maybe? He's usually always here...")
end

return TarroTownBigTree

