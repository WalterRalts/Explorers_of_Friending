--[[
    init.lua
    Created: 08/11/2024 14:35:15
    Description: Autogenerated script file for the map TarroForestPassage.
]]--
-- Commonly included lua functions and data
require 'explorers_of_friending.common'
require 'explorers_of_friending.partner'

-- Package name
local TarroForestPassage = {}

-------------------------------
-- Map Callbacks
-------------------------------
---TarroForestPassage.Init(map)
--Engine callback function
function TarroForestPassage.Init(map)
  MapStrings = STRINGS.MapStrings
  COMMON.RespawnAllies()
  local partner = CH('Teammate1')
  if outside_enter == 1 then
    GROUND:TeleportTo(partner, 557, 504, Direction.Left, 0)
  end
  AI:SetCharacterAI(partner, "origin.ai.ground_partner", CH('PLAYER'), partner.Position)
  partner.CollisionDisabled = true

  if SV.tarro_town.PieChapter < 3 then
    UI:SetSpeaker(partner)
    GROUND:CharTurnToCharAnimated(azura, maru, 4)
    UI:SetSpeakerEmotion("Happy")
    UI:WaitShowDialogue("Okay! There should be an apple around here, I'm sure!")
    SV.tarro_town.PieChapter = 3
  end

  if SV.tarro_town.PieChapter >= 4 then -- after dungeon completion
    GROUND:Hide("Cherry")
    GROUND:Hide("BigApple")
  end

  if SV.tarro_town.DarknessChapter == 1 then
    TarroForestPassage.Darkness()
  end
  
end



---TarroForestPassage.Enter(map)
--Engine callback function
function TarroForestPassage.Enter(map)
  if not Todungeonscene then
    GAME:FadeIn(20)
  else
    Todungeonscene = false
  end
end



---TarroForestPassage.Exit(map)
--Engine callback function
function TarroForestPassage.Exit(map)


end

---TarroForestPassage.Update(map)
--Engine callback function
function TarroForestPassage.Update(map)
  
  Partner()

end

---TarroForestPassage.GameSave(map)
--Engine callback function
function TarroForestPassage.GameSave(map)


end

---TarroForestPassage.GameLoad(map)
--Engine callback function
function TarroForestPassage.GameLoad(map)

end

-------------------------------
-- Entities Callbacks
-------------------------------

function TarroForestPassage.Cherry_Action(obj, activator)
  local maru = CH("PLAYER")
  local azura = CH('Teammate1')
  local cherry = CH("Cherry")

  GROUND:CharTurnToCharAnimated(cherry, maru, 4)
  UI:SetSpeaker(cherry)
  UI:SetSpeakerEmotion("Happy")
  UI:WaitShowDialogue("Hey, did you enjoy that dungeon trip?")

  UI:SetSpeaker(azura)
  UI:SetSpeakerEmotion("Happy")
  UI:WaitShowDialogue("Fun!")

  UI:SetSpeaker(maru)
  UI:SetSpeakerEmotion("Normal")
  UI:WaitShowDialogue("Didn't think there would be a Zubat, though...")

  UI:SetSpeaker(cherry)
  UI:SetSpeakerEmotion("Worried")
  UI:WaitShowDialogue("A Zubat...? [pause=40]I don't remember that?")

  UI:SetSpeaker(maru)
  UI:SetSpeakerEmotion("Worried")
  UI:WaitShowDialogue("Oh, must be a dungeon thing then?")

  UI:SetSpeaker(cherry)
  UI:SetSpeakerEmotion("Normal")
  UI:WaitShowDialogue("...yeah, no,[pause=46] but I'm glad you made it.")
  UI:WaitShowDialogue("The sun here is absolutely divine. [pause=30]G[emote=Happy]et a [speed=0.6]feeeeel.")
end

function TarroForestPassage.TFPassage_DungeonExit_Touch(obj, activator)
  if SV.tarro_town.PieChapter < 4 then
    local azura = CH('Teammate1')
    local maru = CH('PLAYER')
    UI:SetSpeaker(azura)
    UI:SetSpeakerEmotion("Angry")
    UI:WaitShowDialogue("Maru, apple!")

    UI:SetSpeaker(maru)
    UI:SetSpeakerEmotion("Stunned")
    UI:WaitShowDialogue("O-oh,[pause=15] sorry,[pause=10] I...[pause=25] uh...[emote=Happy][pause=20] forgot,[pause=25] haha...")
  elseif SV.tarro_town.PieChapter == 4 then
    GAME:FadeOut(false, 20)
    outside_enter = 4
    GAME:EnterGroundMap("tarro_town_outside", "TarroTownEast", "TTEast_TarroTownForest")
  elseif SV.tarro_town.PieChapter <= 10 then
    GAME:FadeOut(false, 20)
    outside_enter = 4
    GAME:EnterGroundMap("tarro_town_outside", "TarroTownEast_ch2", "TTEast_TarroTownForest")
  else -- == 11
    GAME:FadeOut(false, 20)
    outside_enter = 4
    GAME:EnterGroundMap("tarro_town_outside", "TarroTownEast_ch3", "TTEast_TarroTownForest")
  end
end

function TarroForestPassage.TFPassage_PlazaEnter_Touch(obj, activator)
  GAME:FadeOut(false, 20)
  GAME:EnterGroundMap("TarroForestPlaza", "TarroPlaza_Enter")
end

function TarroForestPassage.Buttums_Action(obj, activator)
  local maru = CH("PLAYER")
  local buttums = CH("Buttums")

  GROUND:CharTurnToCharAnimated(buttums, maru, 4)
  UI:SetSpeaker(buttums)
  UI:SetSpeakerEmotion("Normal")
  
  tarro_dungeonpoints = SV.tarro_forest.dungpoints + SV.deep_tarro_forest.dungpoints + SV.tarro_tree_hollows.dungpoints
  if tarro_dungeonpoints >= 300 then
    if GAME:DungeonUnlocked("deep_tarro_forest") == false or GAME:DungeonUnlocked("deep_tarro_forest") == false then
      UI:SetSpeaker(buttums)
      UI:SetSpeakerEmotion("Worried")
      UI:WaitShowDialogue("Even though you have all the points...")

      UI:SetSpeaker(buttums)
      UI:SetSpeakerEmotion("Pain")
      UI:WaitShowDialogue("You haven't found all the dungeons.")

      UI:SetSpeakerEmotion("Normal")
      UI:WaitShowDialogue("Come back when you're more experienced. Read the sign.")
    else
    end
  else
    UI:WaitShowDialogue("You are not worthy for this place yet; not enough points. Don't forget to read the sign.")
  end
  
end

function TarroForestPassage.Buttums_1_Action(obj, activator)
  UI:ResetSpeaker()
  if sign_tutorial ~= 1 then
    UI:SetAutoFinish(true)
    UI:WaitShowDialogue("You can get dungeon points by doing certain things in a certain group of dungeons.")
    UI:WaitShowDialogue("Some dungeons, including this one, will only require completion. Other dungeons may require certain items to be turned in, or Pokemon to find.")
    UI:WaitShowDialogue("Getting enough dungeon experience will unlock things that will help you on your future journeys, so be sure to complete as many of these as you can.")
    sign_tutorial = 1
  end

  UI:SetAutoFinish(false)
  print(SV.deep_tarro_forest.dungpoints)
  print(SV.tarro_tree_hollows.dungpoints)
  print(GAME:DungeonUnlocked("tarro_tree_hollows"))
  print(GAME:DungeonUnlocked("deep_tarro_forest"))
  tarro_dungeonpoints = SV.tarro_forest.dungpoints + SV.deep_tarro_forest.dungpoints + SV.tarro_tree_hollows.dungpoints
  if SV.deep_tarro_forest.dungpoints > 0 and SV.tarro_tree_hollows.dungpoints > 0 then
    UI:WaitShowDialogue("You currently have " ..tarro_dungeonpoints.. " dungeon points with the Tarro dungeons.")
    --set up some sort of shop behind Buttums here after Buttums lets the Bluetails know about their feats.
  else
    UI:WaitShowDialogue("You haven't explored all of the dungeons needed for this group.")
    UI:WaitShowDialogue("Recheck the sign after you find all of the Tarro dungeons:")
    if SV.deep_tarro_forest.dungpoints == 0 then
      if GAME:DungeonUnlocked("deep_tarro_forest") == false then
        UI:WaitShowDialogue("An undiscovered dungeon still needs to be explored.")
      else
        UI:WaitShowDialogue("Tarro Deep Forest still needs to be explored.")
      end
    end
    if SV.tarro_tree_hollows.dungpoints == 0 then
      if GAME:DungeonUnlocked("tarro_tree_hollows") == false then
        UI:WaitShowDialogue("An undiscovered dungeon still needs to be explored.")
      else
        UI:WaitShowDialogue("Tarro Tree Hollows still needs to be explored.")
      end
    end
    UI:WaitShowDialogue("You currently have " ..tarro_dungeonpoints.. " dungeon points with the Tarro dungeons.")
  end
end

function TarroForestPassage.BigApple_Action(obj, activator)
  GAME:CutsceneMode(true)
  local azura = CH('Teammate1')
  local maru = CH('PLAYER')
  UI:SetSpeaker(azura)
  UI:SetSpeakerEmotion("Inspired")
  UI:WaitShowDialogue("Gasp!")
  UI:SetSpeakerEmotion("Happy")
  GROUND:MoveToPosition(azura, 269, 299, false, 4)
  GROUND:CharAnimateTurn(azura, Direction.UpLeft, 4, true)
  UI:WaitShowDialogue("Big apple, big apple, big apple![pause=35] P[emote=Joyous]ie, pie, pie, pie!")


  UI:SetSpeaker(maru)
  UI:SetSpeakerEmotion("Happy")
  UI:WaitShowDialogue("Alrighty! Now let's bring this back to mom and enjoy some pie.")

  UI:SetSpeaker(azura)
  UI:SetSpeakerEmotion("Joyous")
  UI:WaitShowDialogue("Yippee!")

  GAME:CutsceneMode(false)
  GROUND:Hide("BigApple")
  SV.tarro_town.PieChapter = 4
end

function TarroForestPassage.TF_DeepForestEnter_Touch(obj, activator)
  local maru = CH("PLAYER")

  if SV.tarro_town.DarknessChapter == 2 then
    local dungeon_entrances = {"deep_tarro_forest"}
    local ground_entrances = {}
    COMMON.ShowDestinationMenu(dungeon_entrances, ground_entrances)
  else
    UI:SetSpeaker(maru)
    UI:SetSpeakerEmotion("Worried")
    UI:WaitShowDialogue("(...maybe later...)")
  end
  
end

function TarroForestPassage.AppleTree_Action(obj, activator)
  local apple_give = 0
  UI:ResetSpeaker()
  local choices = {("Yes!"),
    ("No!")}
  UI:BeginChoiceMenu("Shake the tree for an apple?", choices, 1, 2)
  UI:WaitForChoice()
  result = UI:ChoiceResult()
  if result == 1 then
    apple_give = math.random(100)
    print(apple_give)
    GROUND:CharSetAnim(CH("PLAYER"), "Attack", false)
    SOUND:PlaySE("Battle/DUN_Tackle")
    GAME:WaitFrames(4)
    SOUND:PlaySE("Battle/DUN_Leaf_Storm_3")

    GAME:WaitFrames(90)

    if apple_give >= 50 and SV.tarro_forest.apple_tree_get == false then
      SOUND:PlaySE("Battle/EVT_CH02_Item_Place")
      if apple_give >= 85 then
        UI:WaitShowDialogue("Maru got an apple.[pause=60] It's huge!")
        GAME:GivePlayerItem("food_apple_big")
      else
        UI:WaitShowDialogue("Maru got an apple.")
        GAME:GivePlayerItem("food_apple")
      end
      SV.tarro_forest.apple_tree_get = true
    elseif SV.tarro_forest.apple_tree_get == true then
      UI:WaitShowDialogue("Looks like the tree is empty...")
    else
      UI:WaitShowDialogue("Nope.")
    end
  end
end

return TarroForestPassage



