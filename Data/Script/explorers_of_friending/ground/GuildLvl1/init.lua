--[[
    init.lua
    Created: 07/24/2025 21:07:55
    Description: Autogenerated script file for the map GuildLvl1.
]]--
-- Commonly included lua functions and data
require 'explorers_of_friending.common'
require 'explorers_of_friending.guildcutscene'

-- Package name
local GuildLvl1 = {}

-------------------------------
-- Map Callbacks
-------------------------------
---GuildLvl1.Init(map)
--Engine callback function
function GuildLvl1.Init(map)
  COMMON.RespawnAllies()
  GAME:SetCanSwitch(false)
  if SV.guild.day == 0 then
    Tent.Day0()
  elseif SV.guild.day == 1 then
    Tent.Day1End()
  else
    Tent.FreeDay()
  end
end

---GuildLvl1.Enter(map)
--Engine callback function
function GuildLvl1.Enter(map)

  GAME:FadeIn(20)

end

---GuildLvl1.Exit(map)
--Engine callback function
function GuildLvl1.Exit(map)


end

---GuildLvl1.Update(map)
--Engine callback function
function GuildLvl1.Update(map)
  Partner()
end

---GuildLvl1.GameSave(map)
--Engine callback function
function GuildLvl1.GameSave(map)

end

---GuildLvl1.GameLoad(map)
--Engine callback function
function GuildLvl1.GameLoad(map)

  GAME:FadeIn(20)

end

-------------------------------
-- Entities Callbacks
-------------------------------

local rextalk = 0
function GuildLvl1.GuildExit1_Touch(obj, activator)
  if SV.guild.day == 0 then
    local maru = CH("PLAYER")
    UI:SetSpeaker(maru)
    UI:SetSpeakerEmotion("Normal")
    UI:WaitShowDialogue("(There's really nothing to do out there,[pause=25] I'll just stay in here for now.)")
  else
    GAME:FadeOut(false, 30)
    GAME:EnterGroundMap("GuildFieldMain", "Start")
  end
end

function GuildLvl1.MarTouch_Touch(obj, activator)
  local maru = CH("PLAYER")
  if SV.guild.day == 0 then
    UI:ResetSpeaker()
    UI:ChoiceMenuYesNo("Would you like to rest and get ready for tomorrow?", false)
    UI:WaitForChoice()
    local result = UI:ChoiceResult()
    if result then
      GAME:GroundSave()
      UI:WaitShowDialogue("Game saved!")
      GAME:FadeOut(false, 60)
      SV.guild.day = SV.guild.day + 1
      Tent.Day1()
      local partner = CH('Teammate1')
      AI:SetCharacterAI(partner, "origin.ai.ground_partner", CH('PLAYER'), partner.Position)
      partner.CollisionDisabled = true
    else
      UI:SetSpeaker(maru)
      UI:SetSpeakerEmotion("Normal")
      UI:WaitShowDialogue("(Might be missing something.)")
    end
  elseif SV.guild.time > 0 then
    UI:ResetSpeaker()
    UI:ChoiceMenuYesNo("Would you like to rest for tomorrow?", false)
    UI:WaitForChoice()
    local result = UI:ChoiceResult()
    if result then
      GAME:GroundSave()
      UI:WaitShowDialogue("Game saved!")
      GAME:FadeOut(false, 60)
      rextalk = 0
      SV.guild.day = SV.guild.day + 1
      SV.guild.time = 0
    else
      UI:SetSpeaker(maru)
      UI:SetSpeakerEmotion("Normal")
      UI:WaitShowDialogue("(Might be missing something.)")
    end
  end
end

function GuildLvl1.WaterBed_Action(obj, activator)
  local maru = CH("PLAYER")
  local azura = CH("Teammate1")
  local rexio = CH("Teammate2")

  if SV.guild.day == 0 then
    COMMON.SetCharAndEmotion(maru, "Happy")
    UI:WaitShowDialogue("I guess even the water needs a bed.")

    COMMON.SetCharAndEmotion(rexio, "Pain")
    UI:WaitShowDialogue("(Heck! I could've came up with that!)")
  elseif SV.guild.day == 1 then
    COMMON.SetCharAndEmotion(maru, "Normal")
    UI:WaitShowDialogue("I'll have to become the water...")

    COMMON.SetCharAndEmotion(azura, "Worried")
    UI:WaitShowDialogue("Why?")

    COMMON.SetCharAndEmotion(maru, "Normal")
    UI:WaitShowDialogue("To go with the flow.")

    COMMON.SetCharAndEmotion(azura, "Stunned")
    UI:WaitShowDialogue("But it's not moving...")

    COMMON.SetCharAndEmotion(maru, "Normal")
    UI:WaitShowDialogue("...")

    COMMON.SetCharAndEmotion(azura, "Worried")
    UI:WaitShowDialogue("...")
  end
  
end

function GuildLvl1.Teammate1_Action(obj, activator)
  local maru = CH("PLAYER")
  local azura = CH("Teammate1")
  local rexio = CH("Teammate2")

  if SV.guild.day == 0 then
    if rextalk > 1 then
      COMMON.SetCharAndEmotion(azura, "Sad")
      UI:WaitShowDialogue("...")

      COMMON.SetCharAndEmotion(rexio, "Sad")
      UI:WaitShowDialogue("...hmm...")

      COMMON.SetCharAndEmotion(maru, "Stunned")
      UI:WaitShowDialogue("...uh... adventure?")

      COMMON.SetCharAndEmotion(azura, "Worried")
      UI:WaitShowDialogue("...yay, I think.")
    else
      COMMON.SetCharAndEmotion(azura, "Worried")
      UI:WaitShowDialogue("I still don't get it.")

      COMMON.SetCharAndEmotion(maru, "Happy")
      UI:WaitShowDialogue("We're going on adventures tomorrow, Azura.")

      COMMON.SetCharAndEmotion(azura, "Joyous")
      UI:WaitShowDialogue("Yippee!")

      COMMON.SetCharAndEmotion(rexio, "Sad")
      UI:WaitShowDialogue("...")
    end
  end
end

function GuildLvl1.Teammate2_Action(obj, activator)
  local maru = CH("PLAYER")
  local azura = CH("Teammate1")
  local rexio = CH("Teammate2")
  local sadness = false

  if SV.guild.day == 0 then
    if rextalk == 0 then
      rextalk = rextalk + 1
      COMMON.SetCharAndEmotion(rexio, "Sad")
      UI:WaitShowDialogue("Lame... lame...")

      COMMON.SetCharAndEmotion(maru, "Worried")
      UI:WaitShowDialogue("I think it's pretty cool.")

      COMMON.SetCharAndEmotion(rexio, "Worried")
      UI:WaitShowDialogue("Yeah?[pause=30] Well I think it feels lame,[pause=35] so it's lame.")

      COMMON.SetCharAndEmotion(maru, "Stunned")
      UI:WaitShowDialogue("Yeesh.")
    elseif rextalk == 1 then
      rextalk = rextalk + 1
      COMMON.SetCharAndEmotion(rexio, "Worried")
      UI:WaitShowDialogue("I don't get it,[pause=20] you two don't seem like you miss home in the slightest.")

      COMMON.SetCharAndEmotion(azura, "Normal")
      UI:WaitShowDialogue("Mr. Smear said we'd be able to go back home soon.")

      COMMON.SetCharAndEmotion(rexio, "Worried")
      UI:WaitShowDialogue("He also said we would get soft pillows.")
      GROUND:CharSetAnim(azura, "None", true)
      GAME:WaitFrames(90)
      local coro12 = TASK:BranchCoroutine(function()
        GROUND:CharTurnToChar(maru, azura)
        COMMON.CharExclaim("PLAYER")
        repeat
          GROUND:TeleportTo(azura, azura.Position.X, azura.Position.Y - 1, Direction.Left, 0)
          GAME:WaitFrames(2)
          GROUND:TeleportTo(azura, azura.Position.X, azura.Position.Y + 1, Direction.Left, 0)
          GAME:WaitFrames(2)
        until sadness == true
        end)
      local coro11 = TASK:BranchCoroutine(function()
        COMMON.SetCharAndEmotion(azura, "Teary-Eyed")
        UI:WaitShowDialogue("[speed=0.4]W-wait... but...")

        COMMON.SetCharAndEmotion(maru, "Surprised")
        UI:WaitShowDialogue("Azura no no no!!")

        COMMON.SetCharAndEmotion(rexio, "Sad")
        UI:WaitShowDialogue("Tch.")
        sadness = true
        GROUND:CharSetAnim(azura, "Idle", true)
        end)
      TASK:JoinCoroutines({coro11, coro12})
    else
      COMMON.SetCharAndEmotion(rexio, "Worried")
      UI:WaitShowDialogue("...I wanna go home...")

      GROUND:CharTurnToChar(maru, azura)
      COMMON.SetCharAndEmotion(azura, "Teary-Eyed")
      UI:WaitShowDialogue("Mama...")

      COMMON.SetCharAndEmotion(maru, "Stunned")
      UI:WaitShowDialogue("...I guess it's heavy in here now.")
    end
  elseif SV.guild.day == 1 then
    if rextalk == 0 then
      COMMON.SetCharAndEmotion(rexio, "Normal")
      UI:WaitShowDialogue("I'll be there, just...[pause=50] [emote=Happy]give me a moment, mkay?")

      COMMON.SetCharAndEmotion(maru, "Normal")
      UI:WaitShowDialogue("Understood.")
      rextalk = 1
    else
      COMMON.SetCharAndEmotion(rexio, "Normal")
      UI:WaitShowDialogue("I need a sec to think...[pause=30] about this \"guild\".")

      COMMON.SetCharAndEmotion(maru, "Normal")
      UI:WaitShowDialogue("Understood, again.")
    end
  else
    COMMON.SetCharAndEmotion(rexio, "Normal")
    UI:WaitShowDialogue("I'm glad I got to swing a few punches today.")
  end
end

return GuildLvl1

